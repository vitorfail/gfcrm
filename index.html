<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet"  type="text/css" href="style.css">
    <title>GF360 CRM</title>
</head>
<body>
    <div class="barralateral">
        <div class="logo"></div>
        <div class="items">
            <div onclick="home()" class="item">
                <i class="fa-solid fa-house-user"></i>
                <p>Home</p>
            </div>
            <div onclick="cadastro()" class="item">
                <i class="fa-regular fa-id-card"></i>
                <p>Cadastro</p>
            </div>
        </div>
    </div>
    <div class="direito">
        <div class="barra_pesquisa">
            <div class="pesquisar">
                <select>
                    <option>CPF</option>
                    <option>Nome</option>
                    <option>telefone</option>
                </select>
                <input placeholder="Pesquisar..."/>
                <button><i class="fa-solid fa-magnifying-glass"></i></button>    
            </div>
        </div>
        <div class="center">
            <div id="home" class="home">
                <div class="cards">
                    <div class="card" style="color: white; background: green;">
                        <div class="descri">
                            <p style="color: white;">00:00</p>
                        </div>
                        <div class="nome">
                            <p>24 de Setembro</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="descri">
                            <i class="fa-regular fa-user"></i>
                            <p id="total-clientes">0</p>
                        </div>
                        <div class="nome">
                            <p>Clientes</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="descri">
                            <i class="fa-solid fa-cake-candles"></i>
                            <p id="aniversariantes">0</p>
                        </div>
                        <div class="nome">
                            <p>Aniversariantes</p>
                        </div>
                    </div>
                </div>  
                <div style="width: 90%;">
                    <select id="ano" onchange="puxar_ano(this.value)">
                        <option value="1998">1998</option>
                        <option value="1999">1999</option>
                        <option value="2000">2000</option>
                        <option value="2001">2001</option>
                        <option value="2002">2002</option>
                        <option value="2003">2003</option>
                        <option value="2004">2004</option>
                        <option value="2005">2005</option>
                        <option value="2006">2006</option>
                        <option value="2007">2007</option>
                        <option value="2008">2008</option>
                        <option value="2009">2009</option>
                        <option value="2010">2010</option>
                        <option value="2011">2011</option>
                        <option value="2012">2012</option>
                        <option value="2013">2013</option>
                        <option value="2014">2014</option>
                        <option value="2015">2015</option>
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030">2030</option>
                        <option value="2031">2031</option>
                        <option value="2032">2032</option>
                        <option value="2033">2033</option>
                        <option value="2034">2034</option>
                        <option value="2035">2035</option>
                        <option value="2036">2036</option>
                        <option value="2037">2037</option>
                        <option value="2038">2038</option>
                        <option value="2039">2039</option>
                        <option value="2040">2040</option>
                        <option value="2041">2041</option>
                        <option value="2042">2042</option>
                        <option value="2043">2043</option>
                        <option value="2044">2044</option>
                        <option value="2045">2045</option>
                        <option value="2046">2046</option>
                        <option value="2047">2047</option>
                        <option value="2048">2048</option>
                        <option value="2049">2049</option>
                        <option value="2050">2050</option>
                        <option value="2051">2051</option>
                        <option value="2052">2052</option>
                        <option value="2053">2053</option>
                        <option value="2054">2054</option>
                        <option value="2055">2055</option>
                        <option value="2056">2056</option>
                        <option value="2057">2057</option>
                        <option value="2058">2058</option>
                        <option value="2059">2059</option>
                        <option value="2060">2060</option>
                        <option value="2061">2061</option>
                        <option value="2062">2062</option>
                        <option value="2063">2063</option>
                        <option value="2064">2064</option>
                        <option value="2065">2065</option>
                        <option value="2066">2066</option>
                        <option value="2067">2067</option>
                        <option value="2068">2068</option>
                        <option value="2069">2069</option>
                        <option value="2070">2070</option>
                        <option value="2071">2071</option>
                        <option value="2072">2072</option>
                        <option value="2073">2073</option>
                        <option value="2074">2074</option>
                        <option value="2075">2075</option>
                        <option value="2076">2076</option>
                        <option value="2077">2077</option>
                        <option value="2078">2078</option>
                        <option value="2079">2079</option>
                        <option value="2080">2080</option>
                        <option value="2081">2081</option>
                        <option value="2082">2082</option>
                        <option value="2083">2083</option>
                        <option value="2084">2084</option>
                        <option value="2085">2085</option>
                        <option value="2086">2086</option>
                        <option value="2087">2087</option>
                        <option value="2088">2088</option>
                        <option value="2089">2089</option>
                        <option value="2090">2090</option>
                    </select>                    
                </div>
                <div class="planilha">
                    <canvas id="myChart" width="300" height="200"></canvas>
                </div>  
            </div>
            <div id="cadastro" class="cadastro">
                <div class="container">
                    <div class="form">
                        <div class="lado-esquerdo">
                            <p>Nome</p>
                            <input placeholder="Gilberto" id="nome"/>
                            <p>Email</p>
                            <input placeholder="exemplo@hotmail.com" id="email"/>    
                        </div>
                        <div class="lado-direito">
                            <p>Telefone</p>
                            <input placeholder="(00) 00000-0000" maxlength="15" oninput="formatarTelefone(this)" id="telefone"/>
                            <p>Data</p>
                            <input type="text" id="data" placeholder="00/00/0000" maxlength="10"/>    
                        </div>    
                    </div>
                    <button type="button" onclick="registrar(event)">Cadastrar</button>    
                </div>
            </div>
            <div id="aniversariantes" class="aniversariantes">
                <div class="container">
                    <div class="linhas">
                        <p>Nome</p>
                        <p>Número</p>
                        <p>Email</p>
                        <p>Chamado</p>
                    </div>
                    <div class="linhas">
                        <p>Nome</p>
                        <p>Número</p>
                        <p>Email</p>
                        <a href="#"><i class="fa-solid fa-comment"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const sqlite3 = require('sqlite3').verbose();
        const fs = require('fs');
        let Janeiro = 0
        let Fevereiro = 0
        let Março = 0
        let Abril = 0
        let Maio = 0
        let Junho = 0
        let Julho = 0
        let Agosto = 0
        let Setembro = 0
        let Outubro = 0
        let Novembro = 0
        let Dezembro = 0

       window.onload = function() {
            home()
            // Coloque aqui o código que você quer executar após o carregamento da página
        };
       function home(){
            var home_ = document.getElementById("home")
            home_.style.display= "flex"
            var cadastro_ = document.getElementById("cadastro")
            cadastro_.style.display= "none"
            puxar_home()
       }
       function cadastro(){
            var home_ = document.getElementById("home")
            home_.style.display= "none"
            var cadastro_ = document.getElementById("cadastro")
            cadastro_.style.display= "flex"
       }
       function puxar_home(){
        const today = new Date();
        const todayDay = today.getDate(); // Dia atual
        const todayMonth = today.getMonth() + 1;
        var numero_total =0
        var aniversariantes =0
        let db = new sqlite3.Database('./user.db', sqlite3.OPEN_READWRITE, (err) => {
            if (err) {
                console.error(err.message);
            }
        });
        // Consulta o total de clientes na tabela "clientes"
        db.get('SELECT COUNT(*) AS total FROM clientes', [], (err, row) => {
            if (err) {
                throw err;
            }
            numero_total =row.total
            var total = document.getElementById("total-clientes")
            total.textContent = row.total
            if (row.total > 0) {
                
                // Buscar clientes cujo dia e mês de nascimento correspondem à data atual
                db.all(`SELECT nome, dta_nascimento FROM clientes 
                        WHERE strftime('%d', dta_nascimento) = ? AND strftime('%m', dta_nascimento) = ?`, 
                        [todayDay.toString().padStart(2, '0'), todayMonth.toString().padStart(2, '0')], 
                        (err, rows) => {
                    if (err) {
                        throw err;
                    }

                    // Se encontrar usuários com a data de nascimento no dia e mês atuais
                    console.log(rows)
                    if (rows.length > 0) {
                        var aniversariantes = document.getElementById("aniversariantes")
                        aniversariantes.textContent = rows.length
                    } else {
                        console.log("Nenhum cliente faz aniversário hoje.");
                    }
                });
            } else {
                console.log("Não há clientes registrados.");
            }
        });

        // Fecha a conexão com o banco de dados
        db.close((err) => {
            if (err) {
                console.error(err.message);
            }
            console.log('Conexão com o banco de dados fechada.');
        });
       }

        const input = document.getElementById('data');

        input.addEventListener('input', function(e) {
            let value = input.value.replace(/\D/g, ''); // Remove todos os caracteres não numéricos
            let formattedValue = '';

            if (value.length > 0) {
                // Adiciona o dia
                formattedValue = value.substring(0, 2);
            }
            if (value.length >= 3) {
                // Adiciona o mês
                formattedValue += '/' + value.substring(2, 4);
            }
            if (value.length >= 5) {
                // Adiciona o ano
                formattedValue += '/' + value.substring(4, 8);
            }

            input.value = formattedValue;
        });
        function formatarTelefone(input) {
            // Remove todos os caracteres não numéricos
            let valor = input.value.replace(/\D/g, '');

            // Aplica a máscara
            valor = valor.replace(/^(\d{2})(\d)/g, '($1) $2'); // Adiciona (00)
            valor = valor.replace(/(\d{5})(\d)/, '$1-$2'); // Adiciona 00000-
            
            input.value = valor; // Atualiza o input com o valor formatado
        }
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'bar', // Você pode mudar para 'line' ou 'pie' se desejar
            data: {
                labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio','Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro','Novembro', 'Dezembro'],
                datasets: [{
                    label: 'Cadastros Por mês',
                    data: [Janeiro, Fevereiro,Março,Abril, Maio, Junho, Julho, Agosto,Setembro,Outubro, Novembro,Dezembro], // Os valores da distribuição
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(103, 142, 255, 0.2)',
                        'rgba(143, 242, 205, 0.2)',
                        'rgba(43, 192, 105, 0.2)',
                        'rgba(75, 106, 186, 0.2)',
                        'rgba(185, 216, 56, 0.2)',
                        'rgba(154, 102, 135, 0.2)',
                        'rgba(93, 242, 95, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(103, 142, 255, 1)',
                        'rgba(143, 242, 205, 1)',
                        'rgba(43, 192, 105, 1)',
                        'rgba(75, 106, 186, 1)',
                        'rgba(185, 216, 56, 1)',
                        'rgba(154, 102, 135, 1)',
                        'rgba(93, 242, 95, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    
        function puxar_ano(ano){
            const sqlite3 = require('sqlite3').verbose();
            const db = new sqlite3.Database('./user.db');

            const query = `
            WITH meses AS (
                SELECT '01' AS mes, 'Janeiro' AS nome UNION ALL
                SELECT '02', 'Fevereiro' UNION ALL
                SELECT '03', 'Março' UNION ALL
                SELECT '04', 'Abril' UNION ALL
                SELECT '05', 'Maio' UNION ALL
                SELECT '06', 'Junho' UNION ALL
                SELECT '07', 'Julho' UNION ALL
                SELECT '08', 'Agosto' UNION ALL
                SELECT '09', 'Setembro' UNION ALL
                SELECT '10', 'Outubro' UNION ALL
                SELECT '11', 'Novembro' UNION ALL
                SELECT '12', 'Dezembro'
            )

            SELECT 
                m.nome AS mes,
                COUNT(c.id) AS total_cadastros
            FROM 
                meses m
            LEFT JOIN 
                clientes c ON strftime('%m', c.dta_cadastro) = m.mes AND strftime('%Y', c.dta_cadastro) = '${ano}'
            GROUP BY 
                m.mes, m.nome
            ORDER BY 
                m.mes;
            `;

            db.all(query, [], (err, rows) => {
                if (err) {
                    throw err;
                }
                ; // Atualiza o valor do gráfico
                console.log(rows[8].total_cadastros)
                myChart.data.datasets[0].data[0] = rows[0].total_cadastros
                myChart.data.datasets[0].data[1] = rows[1].total_cadastros
                myChart.data.datasets[0].data[2]= rows[2].total_cadastros
                myChart.data.datasets[0].data[3] = rows[3].total_cadastros
                myChart.data.datasets[0].data[4]= rows[4].total_cadastros
                myChart.data.datasets[0].data[5]= rows[5].total_cadastros
                myChart.data.datasets[0].data[6]= rows[6].total_cadastros
                myChart.data.datasets[0].data[7]= rows[7].total_cadastros
                myChart.data.datasets[0].data[8]= rows[8].total_cadastros
                myChart.data.datasets[0].data[9]= rows[9].total_cadastros
                myChart.data.datasets[0].data[10]= rows[10].total_cadastros
                myChart.data.datasets[0].data[11]= rows[11].total_cadastros
                myChart.update()
            });

            db.close();

        }
        function registrar(event) {
            const today = new Date();
            const todayDay = today.getDate(); // Dia atual
            const todayMonth = today.getMonth() + 1;
            var datahoje = today.getFullYear()+'-'+ todayMonth.toString().padStart(2, '0') + '-'+todayDay.toString().padStart(2, '0')

            const sqlite = require("sqlite3").verbose();
            event.preventDefault(); 
            let db = new sqlite.Database('./user.db', sqlite3.OPEN_READWRITE, (err) => {
                if (err) {
                    console.error(err.message);
                    return; // Retorna caso haja erro ao conectar
                }
                console.log('Conectado ao banco de dados SQLite.');
            });
            // Obtendo os valores dos inputs
           const nome = document.getElementById("nome").value;
            const email = document.getElementById("email").value;
            const telefone = document.getElementById("telefone").value.replace(" ", "").replace("(", "").replace(")", "").replace("-", "");
            const dta_nascimento = document.getElementById("data").value;
            var data_forma = dta_nascimento.split("/")
            data_forma = data_forma[2]+"-"+data_forma[1]+"-"+data_forma[0]

            let sql = `INSERT INTO clientes (nome, email, telefone, dta_nascimento, dta_cadastro) VALUES (?, ?, ?, ?,?)`;

            db.run(sql, [nome, email, telefone, data_forma, datahoje], function(err) {
                if (err) {
                    return console.error(err.message);
                }
                return `Cliente adicionado com o ID `;
            });

            // Fecha a conexão com o banco de dados
            db.close((err) => {
                if (err) {
                    console.error(err.message);
                }
                console.log('Conexão com o banco de dados fechada.');
            });   
        }

    </script>
</body>
</html>
